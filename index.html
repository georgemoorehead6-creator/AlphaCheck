<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AlphaCheck</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/sent.png">

    <style>
        :root { --bg: #050505; --card: #121212; --accent: #00FF41; --pointer: #007AFF; --target: #ff3b30; }
        body { 
            background: var(--bg); color: #fff; font-family: ui-monospace, 'Courier New', monospace;
            margin: 0; padding: env(safe-area-inset-top) 15px 40px;
            display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
            overflow: hidden;
        }
        header { padding: 5px 0; border-bottom: 1px solid #222; text-align: center; }
        h1 { margin: 0; font-size: 1.8rem; font-weight: 700; }
        
        input { 
            width: 100%; background: #1a1a1a; border: 2px solid #444; color: var(--accent);
            padding: 12px; border-radius: 6px; font-size: 1.3rem; box-sizing: border-box; text-align: center;
        }

        #visual-area { flex: 0.8; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Fixed Lubber Line (Blue Needle) */
        #lubber-line {
            width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 30px solid var(--pointer); position: absolute;
            top: 25px; z-index: 10;
        }

        /* Rotating Compass Card */
        #compass-card { 
            width: 180px; height: 180px; border: 3px solid #333; border-radius: 50%; position: relative; 
            background: repeating-conic-gradient(from 0deg, #444 0deg 1deg, transparent 1deg 10deg);
            transition: transform 0.2s cubic-bezier(0.1, 0.3, 0.3, 1);
            will-change: transform;
        }
        .cardinal { position: absolute; font-weight: 900; font-size: 1.2rem; color: #fff; }
        .n { top: 10px; left: 50%; transform: translateX(-50%); color: var(--target); }
        .s { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .e { right: 10px; top: 50%; transform: translateY(-50%); }
        .w { left: 10px; top: 50%; transform: translateY(-50%); }

        /* Target Bug (Datum) */
        #target-bug {
            width: 14px; height: 14px; background: var(--target); border-radius: 50%;
            position: absolute; left: calc(50% - 7px); top: 10px;
            transform-origin: center 80px; visibility: hidden;
        }

        #live-hdg-display { font-size: 1.6rem; font-weight: bold; color: var(--pointer); margin-top: 15px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .box { background: var(--card); padding: 10px; border-radius: 4px; border-bottom: 1px solid #333; }
        .label { font-size: 0.65rem; color: #777; text-transform: uppercase; margin-bottom: 2px; font-weight: bold; }
        .value { font-size: 1.4rem; color: var(--accent); font-weight: bold; line-height: 1.1; }
        
        .copy-row { display: flex; justify-content: space-between; align-items: center; }
        #copyBtn { background: #333; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        #status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .init-btn { background: #fff; color: #000; border: none; padding: 25px; font-size: 1.2rem; font-weight: 900; border-radius: 8px; width: 100%; margin-top: 10px; z-index: 100; }
    </style>
</head>
<body>
    <header><h1>AlphaCheck</h1></header>

    <div class="label" style="text-align: center; margin-top: 8px;">Target Datum (Decimal)</div>
    <form action="javascript:void(0);" onsubmit="document.getElementById('targetInput').blur(); updateAll();">
        <input type="text" id="targetInput" placeholder="Lat, Lon" oninput="updateAll()">
    </form>

    <div id="visual-area">
        <div id="lubber-line"></div>
        <div id="compass-card">
            <div class="cardinal n">N</div><div class="cardinal s">S</div>
            <div class="cardinal e">E</div><div class="cardinal w">W</div>
            <div id="target-bug"></div>
        </div>
        <div id="live-hdg-display">000°</div>
    </div>

    <div class="grid">
        <div class="box" style="border-left: 5px solid #ff3b30; display: flex; justify-content: space-between; align-items: center;">
            <div><div class="label">Distance</div><div id="distVal" class="value" style="color: #ff3b30;">0.00 NM</div></div>
            <div style="text-align: right;"><div class="label">Target Brg</div><div id="headVal" class="value" style="color: #ff3b30;">---°</div></div>
        </div>
        <div class="box"><div class="label">DD MM.MMM</div><div id="dmhVal" class="value">--° --.---'</div></div>
        <div class="box"><div class="label">DD MM SS</div><div id="dmsVal" class="value">--° --' --"</div></div>
        <div class="box" style="background: #111; border: 1px solid #444;">
            <div class="label"><span id="status-dot" style="background: #333;"></span>Current Location (WGS84)</div>
            <div class="copy-row">
                <div id="curLoc" class="value" style="color: #fff; font-size: 1.1rem;">Searching...</div>
                <button id="copyBtn" onclick="copyToClipboard()">COPY</button>
            </div>
        </div>
    </div>

    <button id="startBtn" class="init-btn" onclick="initSensors()">INITIALIZE SENSORS</button>

    <script>
        let myPos = { lat: null, lon: null };
        let targetPos = { lat: null, lon: null };
        let currentHeading = 0;
        let lastRotation = 0;

        function toFullCoord(deg, isLat, format) {
            if (deg === null) return "--";
            const dir = isLat ? (deg >= 0 ? 'N' : 'S') : (deg >= 0 ? 'E' : 'W');
            const absDeg = Math.abs(deg);
            const d = Math.floor(absDeg);
            const paddedD = d.toString().padStart(isLat ? 2 : 3, '0');
            if (format === 'DMH') {
                const m = ((absDeg - d) * 60).toFixed(3).padStart(6, '0');
                return `${paddedD}° ${m}' ${dir}`;
            } else {
                const mTotal = (absDeg - d) * 60;
                const m = Math.floor(mTotal).toString().padStart(2, '0');
                const s = Math.round((mTotal - m) * 60).toString().padStart(2, '0');
                return `${paddedD}° ${m}' ${s}" ${dir}`;
            }
        }

        function copyToClipboard() {
            const text = document.getElementById('curLoc').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.innerText = "COPIED!"; btn.style.background = "#00FF41";
                setTimeout(() => { btn.innerText = "COPY"; btn.style.background = "#333"; }, 2000);
            });
        }

        function updateAll() {
            const val = document.getElementById('targetInput').value;
            const parts = val.split(',');
            if (parts.length === 2) {
                targetPos.lat = parseFloat(parts[0]);
                targetPos.lon = parseFloat(parts[1]);
                if (!isNaN(targetPos.lat) && !isNaN(targetPos.lon)) {
                    document.getElementById('dmhVal').innerHTML = `${toFullCoord(targetPos.lat, true, 'DMH')}<br>${toFullCoord(targetPos.lon, false, 'DMH')}`;
                    document.getElementById('dmsVal').innerHTML = `${toFullCoord(targetPos.lat, true, 'DMS')}<br>${toFullCoord(targetPos.lon, false, 'DMS')}`;
                    document.getElementById('target-bug').style.visibility = 'visible';
                }
            }
            calculateMetrics();
        }

        function calculateMetrics() {
            if (myPos.lat === null || targetPos.lat === null) return;
            const R = 3440.065; 
            const dLat = (targetPos.lat - myPos.lat) * Math.PI / 180;
            const dLon = (targetPos.lon - myPos.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(myPos.lat * Math.PI/180) * Math.cos(targetPos.lat * Math.PI/180) * Math.sin(dLon/2)**2;
            const distance = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            document.getElementById('distVal').innerText = distance.toFixed(2) + ' NM';

            const y = Math.sin(dLon) * Math.cos(targetPos.lat * Math.PI/180);
            const x = Math.cos(myPos.lat * Math.PI/180) * Math.sin(targetPos.lat * Math.PI/180) - Math.sin(myPos.lat * Math.PI/180) * Math.cos(targetPos.lat * Math.PI/180) * Math.cos(dLon);
            let bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            document.getElementById('headVal').innerText = Math.round(bearing).toString().padStart(3, '0') + '°';
            
            // Move the target bug on the card
            document.getElementById('target-bug').style.transform = `rotate(${bearing}deg)`;
        }

        async function initSensors() {
            const btn = document.getElementById('startBtn');
            btn.innerText = "WAITING...";
            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') setupOrientation();
                } catch (e) { console.error(e); }
            } else { setupOrientation(); }
            navigator.geolocation.watchPosition(p => {
                myPos.lat = p.coords.latitude; myPos.lon = p.coords.longitude;
                document.getElementById('status-dot').style.background = p.coords.accuracy < 20 ? '#00FF41' : '#FF3B30';
                document.getElementById('curLoc').innerText = `${myPos.lat.toFixed(5)}, ${myPos.lon.toFixed(5)}`;
                calculateMetrics();
                btn.style.display = 'none';
            }, null, { enableHighAccuracy: true });
        }

        function setupOrientation() {
            window.addEventListener('deviceorientation', e => {
                const heading = e.webkitCompassHeading || (360 - e.alpha) || 0;
                
                // Shortest path rotation logic
                let diff = heading - currentHeading;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                lastRotation -= diff;
                
                currentHeading = heading;
                document.getElementById('compass-card').style.transform = `rotate(${lastRotation}deg)`;
                document.getElementById('live-hdg-display').innerText = Math.round(heading).toString().padStart(3, '0') + '°';
            }, true);
        }
    </script>
</body>
</html>
